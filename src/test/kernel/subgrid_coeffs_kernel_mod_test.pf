!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

!> Test the subgrid rho calculation
!>
module subgrid_coeffs_kernel_mod_test

  implicit none

contains

  @test
  subroutine subgrid_coeffs_kernel_test()

    use pFUnit_Mod
    use constants_mod,              only : r_def
    use configuration_mod,          only : CONSTANT_SUBGRID,     &
                                           LINEAR_CENTERED_DIFF, &
                                           MINMOD,               &
                                           PPM_NO_LIMITER, PPM_POSITIVE_ONLY,  &
                                           PPM_POSITIVE_MONOTONE,       &
                                           rho_stencil_length

    use subgrid_coeffs_kernel_mod,  only : subgrid_coeffs_code

    implicit none

    real(kind=r_def) :: tol
    real(kind=r_def) :: answer(1:3)
    real(kind=r_def) :: a0(1:5)
    real(kind=r_def) :: a1(1:5)
    real(kind=r_def) :: a2(1:5)
    real(kind=r_def) :: coeffs(1:3)
    real(kind=r_def) :: rho(5)

    integer          :: nlayers
    integer          :: cell
    integer          :: undf_w3
    integer          :: ndf_w3
    integer          :: dof_map(1,1:5)
    integer          :: i,j,k
    integer          :: subgridrho_option

    tol     = 1.0e-12_r_def
    nlayers = 1
    cell    = 1
    undf_w3 = 5
    ndf_w3  = 1
    dof_map(1,:) = (/ 1,2,3,4,5 /)

    ! Test constant coefficients
    subgridrho_option = CONSTANT_SUBGRID
    rho(:) = (/ 3.0_r_def,2.0_r_def,4.0_r_def,1.0_r_def,5.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ 3.0_r_def, 0.0_r_def, 0.0_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    subgridrho_option = LINEAR_CENTERED_DIFF
    rho(:) = (/ 3.0_r_def,2.0_r_def,4.0_r_def,1.0_r_def,5.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ 2.5_r_def, 1.0_r_def, 0.0_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    subgridrho_option = MINMOD
    rho(:) = (/ 3.0_r_def,2.0_r_def,4.0_r_def,1.0_r_def,5.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ 2.5_r_def, 1.0_r_def, 0.0_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    subgridrho_option = LINEAR_CENTERED_DIFF
    rho(:) = (/ 3.0_r_def,2.0_r_def,4.0_r_def,1.0_r_def,5.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ 2.5_r_def, 1.0_r_def, 0.0_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    ! Test PPM
    subgridrho_option = PPM_NO_LIMITER
    rho(:) = (/ 3.0_r_def,2.0_r_def,4.0_r_def,1.0_r_def,5.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ 2.5_r_def, 1.0_r_def, 0.0_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    ! Test PPM
    subgridrho_option = PPM_NO_LIMITER
    rho(:) = (/ 5.0_r_def/2.0_r_def,3.0_r_def/2.0_r_def,7.0_r_def/2.0_r_def,1.0_r_def/2.0_r_def,9.0_r_def/2.0_r_def /) ! Linear rho
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ 2.0_r_def, 1.0_r_def, 0.0_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    subgridrho_option = PPM_NO_LIMITER
    rho(:) = (/ 10.0_r_def+1.0_r_def/3.0_r_def,10.0_r_def+1.0_r_def/3.0_r_def,10.0_r_def+7.0_r_def/3.0_r_def,   &
                10.0_r_def+7.0_r_def/3.0_r_def,10.0_r_def+19.0_r_def/3.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ 10.0_r_def, 0.0_r_def, 1.0_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    subgridrho_option = PPM_NO_LIMITER
    rho(:) = (/ 10.0_r_def+5.0_r_def/6.0_r_def,9.0_r_def+5.0_r_def/6.0_r_def,13.0_r_def+5.0_r_def/6.0_r_def,   &
                10.0_r_def+5.0_r_def/6.0_r_def,18.0_r_def+5.0_r_def/6.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ 10.0_r_def, 1.0_r_def, 1.0_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    ! Test the monotonicity/positivity limiters.
    subgridrho_option = PPM_NO_LIMITER
    rho(:) = (/ 1.0_r_def/30.0_r_def,1.0_r_def/30.0_r_def,2.0_r_def+1.0_r_def/30.0_r_def,  &
                2.0_r_def+1.0_r_def/30.0_r_def,6.0_r_def+1.0_r_def/30.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ -0.30_r_def, 0.0_r_def, 1.0_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    subgridrho_option = PPM_POSITIVE_ONLY
    rho(:) = (/ 1.0_r_def/30.0_r_def,1.0_r_def/30.0_r_def,2.0_r_def+1.0_r_def/30.0_r_def,  &
                2.0_r_def+1.0_r_def/30.0_r_def,6.0_r_def+1.0_r_def/30.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,(/ 1,2,3,4,5/),a0,a1,a2)
    answer(:) = (/ 0.0_r_def, -1.2_r_def, 1.9_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

    subgridrho_option = PPM_POSITIVE_MONOTONE
    rho(:) = (/ 1.0_r_def/30.0_r_def,1.0_r_def/30.0_r_def,2.0_r_def+1.0_r_def/30.0_r_def,  &
                2.0_r_def+1.0_r_def/30.0_r_def,6.0_r_def+1.0_r_def/30.0_r_def /)
    call subgrid_coeffs_code(nlayers,subgridrho_option,undf_w3,rho,ndf_w3,rho_stencil_length,dof_map,a0,a1,a2)
    answer(:) = (/ 0.0_r_def, 0.0_r_def, 0.1_r_def /)
    @assertEqual(answer(1), a0(1), tol)
    @assertEqual(answer(2), a1(1), tol)
    @assertEqual(answer(3), a2(1), tol)

  end subroutine subgrid_coeffs_kernel_test

end module subgrid_coeffs_kernel_mod_test
