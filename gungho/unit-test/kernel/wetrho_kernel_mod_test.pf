!-----------------------------------------------------------------------------
! (C) Crown copyright 2018 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------
!> Test the wet density (rho) kernel
!>
module wetrho_kernel_mod_test

  use pFUnit_Mod
  use yaxt,                          only : xt_initialize, xt_finalize
  use constants_mod,                 only : r_def, i_def
  use mpi_mod,                       only : store_comm, clear_comm

  implicit none

  private
  public :: test_wetrho

  @TestCase
  type, extends(MPITestCase), public  :: wetrho_test_type
    private
    real(kind=r_def), allocatable :: answer_rho(:), rho(:),  &
                                     mr_v(:), mr_cl(:),      &
                                     mr_r(:), mr_ci(:),      &
                                     mr_s(:), mr_g(:)
  contains
    procedure setUp
    procedure tearDown
    procedure test_wetrho
  end type wetrho_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

  implicit none

  class(wetrho_test_type), intent(inout) :: this

  integer(kind=i_def) :: undf_wth

  ! Initialise YAXT
  call xt_initialize(this%getMpiCommunicator())
  ! Store the MPI communicator for later use
  call store_comm(this%getMpiCommunicator())

  undf_wth = 1_i_def

  allocate( this%answer_rho(undf_wth) )
  allocate( this%rho(undf_wth) )
  allocate( this%mr_v(undf_wth) )
  allocate( this%mr_cl(undf_wth) )
  allocate( this%mr_r(undf_wth) )
  allocate( this%mr_ci(undf_wth) )
  allocate( this%mr_s(undf_wth) )
  allocate( this%mr_g(undf_wth) )

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

  implicit none

  class(wetrho_test_type), intent(inout) :: this

  deallocate ( this%answer_rho, this%rho, this%mr_v, this%mr_cl,    &
               this%mr_r, this%mr_ci, this%mr_s, this%mr_g )

  ! Finalise YAXT
  call xt_finalize()
  ! Clear the stored MPI communicator
  call clear_comm()

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test( npes=[1] )
  subroutine test_wetrho( this )

  use wetrho_kernel_mod, only : wetrho_code

  implicit none

  class(wetrho_test_type), intent(inout) :: this

  real(kind=r_def), parameter   :: tol = 1.0e-14_r_def

  ! Argument list variables for wetrho_code
  integer(kind=i_def), allocatable :: map_wth(:)
  integer(kind=i_def)              :: nlayers
  integer(kind=i_def)              :: ndf_wth
  integer(kind=i_def)              :: undf_wth

  nlayers  = 1_i_def
  ndf_wth  = 1_i_def
  undf_wth = 1_i_def

  allocate(map_wth(ndf_wth))
  map_wth(:)  = 0_i_def


  ! Set initial fields
  this%rho(:)   = 1.0_r_def
  this%mr_v(:)  = 1.0_r_def
  this%mr_cl(:) = 1.0_r_def
  this%mr_r(:)  = 1.0_r_def
  this%mr_ci(:) = 1.0_r_def
  this%mr_s(:)  = 1.0_r_def
  this%mr_g(:)  = 1.0_r_def

  ! Set correct answer
  this%answer_rho(:) = 7.0_r_def

  call wetrho_code( nlayers,       &
                    this%rho(:),   &
                    this%mr_v(:),  &
                    this%mr_cl(:), &
                    this%mr_r(:),  &
                    this%mr_ci(:), &
                    this%mr_s(:),  &
                    this%mr_g(:),  &
                    ndf_wth,       &
                    undf_wth,      &
                    map_wth )

  @assertEqual(this%answer_rho(:), this%rho(:), tol )

  deallocate( map_wth )

  end subroutine test_wetrho

end module wetrho_kernel_mod_test