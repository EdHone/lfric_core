!-----------------------------------------------------------------------------
! Copyright (c) 2019,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------

! Test the initial_jules_kernel

module initial_jules_kernel_mod_test

  use constants_mod, only : r_def, i_def
  use pFUnit_Mod
  use yaxt,                          only : xt_initialize, xt_finalize
  use mpi_mod,                       only : store_comm, clear_comm

  implicit none

  private
  public:: test_of_initial_jules

  @TestCase
  type, extends(MPITestCase), public :: jules_test_type
    private
    real(r_def), allocatable ::                                    &
      tile_fraction(:),          answer_tile_fraction(:),          &
      leaf_area_index(:),        answer_leaf_area_index(:),        &
      canopy_height(:),          answer_canopy_height(:),          &
      tile_temperature(:),       answer_tile_temperature(:),       &
      tile_snow_mass(:),         answer_tile_snow_mass(:),         &
      n_snow_layers(:),          answer_n_snow_layers(:),          &
      snow_depth(:),             answer_snow_depth(:),             &
      soil_temperature(:),       answer_soil_temperature(:),       &
      soil_moisture(:),          answer_soil_moisture(:),          &
      unfrozen_soil_moisture(:), answer_unfrozen_soil_moisture(:), &
      frozen_soil_moisture(:),   answer_frozen_soil_moisture(:),   &
      snow_layer_thickness(:),   answer_snow_layer_thickness(:),   &
      snow_layer_ice_mass(:),    answer_snow_layer_ice_mass(:),    &
      snow_layer_temp(:),        answer_snow_layer_temp(:)

  contains
    procedure setUp
    procedure tearDown
    procedure test_of_initial_jules
  end type jules_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    use feign_config_mod, only: feign_surface_config, feign_idealised_config

    use idealised_config_mod, only: test_snow

    implicit none

    class(jules_test_type), intent(inout) :: this

    integer(kind=i_def) :: undf_tile
    integer(kind=i_def) :: undf_pft
    integer(kind=i_def) :: undf_snow
    integer(kind=i_def) :: undf_soil

    real(r_def), parameter :: brd_leaf = 0.0_r_def
    real(r_def), parameter :: ndl_leaf = 0.0_r_def
    real(r_def), parameter :: c3_grass = 0.0_r_def
    real(r_def), parameter :: c4_grass = 0.0_r_def
    real(r_def), parameter :: shrub    = 0.0_r_def
    real(r_def), parameter :: urban    = 0.0_r_def
    real(r_def), parameter :: lake     = 0.0_r_def
    real(r_def), parameter :: soil     = 1.0_r_def
    real(r_def), parameter :: ice      = 0.0_r_def
    real(r_def), parameter :: sea      = 0.0_r_def
    real(r_def), parameter :: sea_ice  = 0.0_r_def

    undf_tile = 11_i_def
    undf_pft  = 5_i_def
    undf_snow = 27_i_def
    undf_soil = 4_i_def

    ! Initialise YAXT
    call xt_initialize(this%getMpiCommunicator())
    ! Store the MPI communicator for later use
    call store_comm(this%getMpiCommunicator())

    call feign_surface_config( surf_tile_fracs=[brd_leaf, ndl_leaf, c3_grass, &
                                                c4_grass, shrub, urban, lake, &
                                                soil, ice, sea, sea_ice],     &
                               use_hydrology=.false. )

    call feign_idealised_config( test = test_snow )

    allocate( this%tile_fraction(undf_tile) )
    allocate( this%leaf_area_index(undf_pft) )
    allocate( this%canopy_height(undf_pft) )
    allocate( this%tile_temperature(undf_tile) )
    allocate( this%tile_snow_mass(undf_tile) )
    allocate( this%n_snow_layers(undf_tile) )
    allocate( this%snow_depth(undf_tile) )
    allocate( this%soil_temperature(undf_soil) )
    allocate( this%soil_moisture(undf_soil) )
    allocate( this%unfrozen_soil_moisture(undf_soil) )
    allocate( this%frozen_soil_moisture(undf_soil) )
    allocate( this%snow_layer_thickness(undf_snow) )
    allocate( this%snow_layer_ice_mass(undf_snow) )
    allocate( this%snow_layer_temp(undf_snow) )

    allocate( this%answer_tile_fraction(undf_tile) )
    allocate( this%answer_leaf_area_index(undf_pft) )
    allocate( this%answer_canopy_height(undf_pft) )
    allocate( this%answer_tile_temperature(undf_tile) )
    allocate( this%answer_tile_snow_mass(undf_tile) )
    allocate( this%answer_n_snow_layers(undf_tile) )
    allocate( this%answer_snow_depth(undf_tile) )
    allocate( this%answer_soil_temperature(undf_soil) )
    allocate( this%answer_soil_moisture(undf_soil) )
    allocate( this%answer_unfrozen_soil_moisture(undf_soil) )
    allocate( this%answer_frozen_soil_moisture(undf_soil) )
    allocate( this%answer_snow_layer_thickness(undf_snow) )
    allocate( this%answer_snow_layer_ice_mass(undf_snow) )
    allocate( this%answer_snow_layer_temp(undf_snow) )

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    use configuration_mod,        only: final_configuration

    implicit none

    class(jules_test_type), intent(inout) :: this

    deallocate( this%answer_tile_fraction,         this%tile_fraction,         &
                this%answer_leaf_area_index,       this%leaf_area_index,       &
                this%answer_canopy_height,         this%canopy_height,         &
                this%answer_tile_temperature,      this%tile_temperature,      &
                this%answer_tile_snow_mass,        this%tile_snow_mass,        &
                this%answer_n_snow_layers,         this%n_snow_layers,         &
                this%answer_snow_depth,            this%snow_depth,            &
                this%answer_soil_temperature,      this%soil_temperature,      &
                this%answer_soil_moisture,         this%soil_moisture,         &
                this%answer_unfrozen_soil_moisture,this%unfrozen_soil_moisture,&
                this%answer_frozen_soil_moisture,  this%frozen_soil_moisture,  &
                this%answer_snow_layer_thickness,  this%snow_layer_thickness,  &
                this%answer_snow_layer_ice_mass,   this%snow_layer_ice_mass,   &
                this%answer_snow_layer_temp,       this%snow_layer_temp)

    ! Finalise YAXT
    call xt_finalize()
    ! Clear the stored MPI communicator
    call clear_comm()

    ! Finalise namelists
    call final_configuration()

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test( npes=[1] )
  subroutine test_of_initial_jules( this )

    use initial_jules_kernel_mod, only : initial_jules_code
    use constants_mod, only: rmdi

    implicit none

    class(jules_test_type), intent(inout) :: this

    real(kind=r_def), parameter :: tol = 1.0e-14_r_def

    integer(kind=i_def) :: i, nlayers
    integer(kind=i_def) :: n_surf_tile
    integer(kind=i_def) :: max_snow_levs
    integer(kind=i_def) :: n_land_tile

    integer(kind=i_def)              :: ndf_tile, undf_tile
    integer(kind=i_def), allocatable :: map_tile(:)
    integer(kind=i_def)              :: ndf_pft, undf_pft
    integer(kind=i_def), allocatable :: map_pft(:)
    integer(kind=i_def)              :: ndf_snow, undf_snow
    integer(kind=i_def), allocatable :: map_snow(:)
    integer(kind=i_def)              :: ndf_soil, undf_soil
    integer(kind=i_def), allocatable :: map_soil(:)

    n_surf_tile = 11_i_def
    n_land_tile = 9_i_def
    max_snow_levs = 3_i_def

    ndf_tile  = n_surf_tile
    undf_tile = n_surf_tile
    allocate(map_tile(ndf_tile))
    do i=1_i_def, ndf_tile
      map_tile(i) = i
    end do

    ndf_pft  = 5_i_def
    undf_pft = 5_i_def
    allocate(map_pft(ndf_pft))
    do i=1_i_def, ndf_pft
      map_pft(i) = i
    end do

    ndf_snow  = n_land_tile*max_snow_levs
    undf_snow = n_land_tile*max_snow_levs
    allocate(map_snow(ndf_snow))
    do i=1_i_def, ndf_snow
      map_snow(i) = i
    end do

    ndf_soil  = 4_i_def
    undf_soil = 4_i_def
    allocate(map_soil(ndf_soil))
    do i=1_i_def, ndf_soil
      map_soil(i) = i
    end do

    ! Set correct answers
    this%answer_tile_fraction(:)           = 0.0_r_def
    this%answer_tile_fraction(map_tile(8)) = 1.0_r_def

    this%answer_leaf_area_index(map_pft(1)) = 5.0_r_def
    this%answer_leaf_area_index(map_pft(2)) = 4.0_r_def
    this%answer_leaf_area_index(map_pft(3)) = 2.0_r_def
    this%answer_leaf_area_index(map_pft(4)) = 4.0_r_def
    this%answer_leaf_area_index(map_pft(5)) = 1.0_r_def

    this%answer_canopy_height(map_pft(1)) = 19.01_r_def
    this%answer_canopy_height(map_pft(2)) = 16.38_r_def
    this%answer_canopy_height(map_pft(3)) =  1.46_r_def
    this%answer_canopy_height(map_pft(4)) =  1.26_r_def
    this%answer_canopy_height(map_pft(5)) =  1.59_r_def

    this%answer_tile_temperature(:) = 270.0_r_def
    this%answer_tile_snow_mass(:)   = 50.0_r_def
    this%answer_n_snow_layers(:)    = 3.0_r_def
    this%answer_snow_depth(:)       = 2.0_r_def

    this%answer_soil_temperature(map_soil(1)) = 270.0_r_def
    this%answer_soil_temperature(map_soil(2)) = 270.0_r_def
    this%answer_soil_temperature(map_soil(3)) = 275.0_r_def
    this%answer_soil_temperature(map_soil(4)) = 275.0_r_def

    this%answer_soil_moisture(map_soil(1)) = 40.0_r_def
    this%answer_soil_moisture(map_soil(2)) = 90.0_r_def
    this%answer_soil_moisture(map_soil(3)) = 150.0_r_def
    this%answer_soil_moisture(map_soil(4)) = 460.0_r_def

    this%answer_unfrozen_soil_moisture(map_soil(1)) = 0.46896_r_def
    this%answer_unfrozen_soil_moisture(map_soil(2)) = 0.46911_r_def
    this%answer_unfrozen_soil_moisture(map_soil(3)) = 0.51408_r_def
    this%answer_unfrozen_soil_moisture(map_soil(4)) = 0.51096_r_def

    this%answer_frozen_soil_moisture(map_soil(1)) = 0.42210_r_def
    this%answer_frozen_soil_moisture(map_soil(2)) = 0.33285_r_def
    this%answer_frozen_soil_moisture(map_soil(3)) = 0.0_r_def
    this%answer_frozen_soil_moisture(map_soil(4)) = 0.0_r_def

    this%answer_snow_layer_thickness(map_snow(1)) = 0.04_r_def
    this%answer_snow_layer_thickness(map_snow(2)) = 0.12_r_def
    this%answer_snow_layer_thickness(map_snow(3)) = 1.5_r_def
    this%answer_snow_layer_thickness(map_snow(4)) = 0.04_r_def
    this%answer_snow_layer_thickness(map_snow(5)) = 0.12_r_def
    this%answer_snow_layer_thickness(map_snow(6)) = 1.5_r_def
    this%answer_snow_layer_thickness(map_snow(7)) = 0.04_r_def
    this%answer_snow_layer_thickness(map_snow(8)) = 0.12_r_def
    this%answer_snow_layer_thickness(map_snow(9)) = 1.5_r_def
    this%answer_snow_layer_thickness(map_snow(10)) = 0.04_r_def
    this%answer_snow_layer_thickness(map_snow(11)) = 0.12_r_def
    this%answer_snow_layer_thickness(map_snow(12)) = 1.5_r_def
    this%answer_snow_layer_thickness(map_snow(13)) = 0.04_r_def
    this%answer_snow_layer_thickness(map_snow(14)) = 0.12_r_def
    this%answer_snow_layer_thickness(map_snow(15)) = 1.5_r_def
    this%answer_snow_layer_thickness(map_snow(16)) = 0.04_r_def
    this%answer_snow_layer_thickness(map_snow(17)) = 0.12_r_def
    this%answer_snow_layer_thickness(map_snow(18)) = 1.5_r_def
    this%answer_snow_layer_thickness(map_snow(19)) = 0.04_r_def
    this%answer_snow_layer_thickness(map_snow(20)) = 0.12_r_def
    this%answer_snow_layer_thickness(map_snow(21)) = 1.5_r_def
    this%answer_snow_layer_thickness(map_snow(22)) = 0.04_r_def
    this%answer_snow_layer_thickness(map_snow(23)) = 0.12_r_def
    this%answer_snow_layer_thickness(map_snow(24)) = 1.5_r_def
    this%answer_snow_layer_thickness(map_snow(25)) = 0.04_r_def
    this%answer_snow_layer_thickness(map_snow(26)) = 0.12_r_def
    this%answer_snow_layer_thickness(map_snow(27)) = 1.5_r_def

    this%answer_snow_layer_ice_mass(map_snow(1)) = 8.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(2)) = 25.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(3)) = 50.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(4)) = 8.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(5)) = 25.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(6)) = 50.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(7)) = 8.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(8)) = 25.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(9)) = 50.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(10)) = 8.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(11)) = 25.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(12)) = 50.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(13)) = 8.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(14)) = 25.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(15)) = 50.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(16)) = 8.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(17)) = 25.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(18)) = 50.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(19)) = 8.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(20)) = 25.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(21)) = 50.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(22)) = 8.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(23)) = 25.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(24)) = 50.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(25)) = 8.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(26)) = 25.0_r_def
    this%answer_snow_layer_ice_mass(map_snow(27)) = 50.0_r_def

    this%answer_snow_layer_temp(map_snow(1)) = 260.0_r_def
    this%answer_snow_layer_temp(map_snow(2)) = 265.0_r_def
    this%answer_snow_layer_temp(map_snow(3)) = 270.0_r_def
    this%answer_snow_layer_temp(map_snow(4)) = 260.0_r_def
    this%answer_snow_layer_temp(map_snow(5)) = 265.0_r_def
    this%answer_snow_layer_temp(map_snow(6)) = 270.0_r_def
    this%answer_snow_layer_temp(map_snow(7)) = 260.0_r_def
    this%answer_snow_layer_temp(map_snow(8)) = 265.0_r_def
    this%answer_snow_layer_temp(map_snow(9)) = 270.0_r_def
    this%answer_snow_layer_temp(map_snow(10)) = 260.0_r_def
    this%answer_snow_layer_temp(map_snow(11)) = 265.0_r_def
    this%answer_snow_layer_temp(map_snow(12)) = 270.0_r_def
    this%answer_snow_layer_temp(map_snow(13)) = 260.0_r_def
    this%answer_snow_layer_temp(map_snow(14)) = 265.0_r_def
    this%answer_snow_layer_temp(map_snow(15)) = 270.0_r_def
    this%answer_snow_layer_temp(map_snow(16)) = 260.0_r_def
    this%answer_snow_layer_temp(map_snow(17)) = 265.0_r_def
    this%answer_snow_layer_temp(map_snow(18)) = 270.0_r_def
    this%answer_snow_layer_temp(map_snow(19)) = 260.0_r_def
    this%answer_snow_layer_temp(map_snow(20)) = 265.0_r_def
    this%answer_snow_layer_temp(map_snow(21)) = 270.0_r_def
    this%answer_snow_layer_temp(map_snow(22)) = 260.0_r_def
    this%answer_snow_layer_temp(map_snow(23)) = 265.0_r_def
    this%answer_snow_layer_temp(map_snow(24)) = 270.0_r_def
    this%answer_snow_layer_temp(map_snow(25)) = 260.0_r_def
    this%answer_snow_layer_temp(map_snow(26)) = 265.0_r_def
    this%answer_snow_layer_temp(map_snow(27)) = 270.0_r_def

    ! Make up initial wrong fields
    this%tile_fraction(:)          = rmdi
    this%leaf_area_index(:)        = rmdi
    this%canopy_height(:)          = rmdi
    this%tile_temperature(:)       = rmdi
    this%tile_snow_mass(:)         = rmdi
    this%n_snow_layers(:)          = rmdi
    this%snow_depth(:)             = rmdi
    this%soil_temperature(:)       = rmdi
    this%soil_moisture(:)          = rmdi
    this%unfrozen_soil_moisture(:) = rmdi
    this%frozen_soil_moisture(:)   = rmdi
    this%snow_layer_thickness(:)   = rmdi
    this%snow_layer_ice_mass(:)    = rmdi
    this%snow_layer_temp(:)        = rmdi

    call initial_jules_code(nlayers,                       &
                            this%tile_fraction(:),         &
                            this%leaf_area_index(:),       &
                            this%canopy_height(:),         &
                            this%tile_temperature(:),      &
                            this%tile_snow_mass(:),        &
                            this%n_snow_layers(:),         &
                            this%snow_depth(:),            &
                            this%soil_temperature(:),      &
                            this%soil_moisture(:),         &
                            this%unfrozen_soil_moisture(:),&
                            this%frozen_soil_moisture(:),  &
                            this%snow_layer_thickness(:),  &
                            this%snow_layer_ice_mass(:),   &
                            this%snow_layer_temp(:),       &
                            n_surf_tile,                   &
                            n_land_tile,                   &
                            max_snow_levs,                 &
                            ndf_tile, undf_tile, map_tile, &
                            ndf_pft, undf_pft, map_pft,    &
                            ndf_soil, undf_soil, map_soil, &
                            ndf_snow, undf_snow, map_snow)

    @assertEqual( this%answer_tile_fraction(:),          this%tile_fraction(:), tol )
    @assertEqual( this%answer_leaf_area_index(:),        this%leaf_area_index(:), tol )
    @assertEqual( this%answer_canopy_height(:),          this%canopy_height(:), tol )
    @assertEqual( this%answer_tile_temperature(:),       this%tile_temperature(:), tol )
    @assertEqual( this%answer_tile_snow_mass(:),         this%tile_snow_mass(:), tol )
    @assertEqual( this%answer_n_snow_layers(:),          this%n_snow_layers(:), tol )
    @assertEqual( this%answer_snow_depth(:),             this%snow_depth(:), tol )
    @assertEqual( this%answer_soil_temperature(:),       this%soil_temperature(:), tol )
    @assertEqual( this%answer_soil_moisture(:),          this%soil_moisture(:), tol )
    @assertEqual( this%answer_unfrozen_soil_moisture(:), this%unfrozen_soil_moisture(:), tol )
    @assertEqual( this%answer_frozen_soil_moisture(:),   this%frozen_soil_moisture(:), tol )

  end subroutine test_of_initial_jules

end module initial_jules_kernel_mod_test
